<!doctype html><html lang=en-ch dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="docker日常使用"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Docker笔记"><meta property="og:description" content="docker日常使用"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/docker-note/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-09T14:30:50+08:00"><meta property="article:modified_time" content="2024-03-09T14:30:50+08:00"><title>Docker笔记 | TwoMental's Blog</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=canonical href=http://localhost:1313/posts/docker-note/><link rel=stylesheet href=/book.min.309b7ed028807cdb68d8d61e26d609f48369c098dbf5e4d8c0dcf4cdf49feafc.css integrity="sha256-MJt+0CiAfNto2NYeJtYJ9INpwJjb9eTYwNz0zfSf6vw=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.b3fbed1cc8ff805cb3e98a9678175a4dedecb38e4ead0e130a5db1e472d64780.js integrity="sha256-s/vtHMj/gFyz6YqWeBdaTe3ss45OrQ4TCl2x5HLWR4A=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>TwoMental's Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Docker笔记</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#11-docker原理>1.1 Docker原理</a></li><li><a href=#12-vs-虚拟机>1.2 VS 虚拟机</a></li></ul><ul><li><a href=#21-获取镜像>2.1 获取镜像</a></li></ul><ul><li><a href=#31-构建镜像流程>3.1 构建镜像流程</a></li><li><a href=#32-编写dockerfile>3.2 编写Dockerfile</a></li><li><a href=#33-跨cpu架构build>3.3 跨CPU架构build</a><ul><li><a href=#331-buildx>3.3.1 buildx</a></li><li><a href=#332-manifest>3.3.2 manifest</a></li></ul></li></ul><ul><li><a href=#41-容器启动停止>4.1 容器启动/停止</a></li><li><a href=#42-容器查看>4.2 容器查看</a></li><li><a href=#43-容器删除>4.3 容器删除</a></li></ul></nav></aside></header><article class="markdown book-post"><h1><a href=/posts/docker-note/>Docker笔记</a></h1><h5>March 9, 2024</h5><div><a href=/tags/docker/>Docker</a>,
<a href=/tags/dockerfile/>Dockerfile</a></div><h1 id=1-基本介绍>1. 基本介绍
<a class=anchor href=#1-%e5%9f%ba%e6%9c%ac%e4%bb%8b%e7%bb%8d>#</a></h1><h2 id=11-docker原理>1.1 Docker原理
<a class=anchor href=#11-docker%e5%8e%9f%e7%90%86>#</a></h2><p>TODO</p><h2 id=12-vs-虚拟机>1.2 VS 虚拟机
<a class=anchor href=#12-vs-%e8%99%9a%e6%8b%9f%e6%9c%ba>#</a></h2><p>TODO</p><h1 id=2-使用别人的镜像>2. 使用别人的镜像
<a class=anchor href=#2-%e4%bd%bf%e7%94%a8%e5%88%ab%e4%ba%ba%e7%9a%84%e9%95%9c%e5%83%8f>#</a></h1><h2 id=21-获取镜像>2.1 获取镜像
<a class=anchor href=#21-%e8%8e%b7%e5%8f%96%e9%95%9c%e5%83%8f>#</a></h2><ul><li>如果是拉在<a href=https://hub.docker.com/>Docker Hub</a>注册的镜像，比如python的镜像<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 明确tag</span>
</span></span><span style=display:flex><span>docker pull python:3.9.0
</span></span><span style=display:flex><span><span style=color:#75715e># 不明确tag默认为latest</span>
</span></span><span style=display:flex><span>docker pull python
</span></span></code></pre></div></li><li>如果是拉非Docker hub注册的公开镜像，比如elastic公司的logstash镜像<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 镜像名构成：地址/命名空间/镜像名[:镜像tag]</span>
</span></span><span style=display:flex><span>docker pull docker.elastic.co/logstash/logstash:7.6.0
</span></span></code></pre></div></li><li>如果是拉非公开镜像，比如自己仓库的镜像<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 先登录</span>
</span></span><span style=display:flex><span>docker login xxx.xxx
</span></span><span style=display:flex><span><span style=color:#75715e># 再拉镜像</span>
</span></span><span style=display:flex><span>docker pull xxx.xxx/some_project/some_img:0.1.0
</span></span></code></pre></div></li><li>如果镜像仓库不是https<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 修改/etc/docker/daemon.json</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加 &#34;insecure-registries&#34;:[&#34;192.166.1.23:5001&#34;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启docker</span>
</span></span><span style=display:flex><span>systemctl restart docker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 登录</span>
</span></span><span style=display:flex><span>docker login 192.166.1.23:5001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 再拉镜像</span>
</span></span><span style=display:flex><span>docker pull 192.166.1.23:5001/some_project/some_img:0.1.0
</span></span></code></pre></div></li><li>如果要运行的环境甚至不能联网<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 保存镜像</span>
</span></span><span style=display:flex><span>docker save nginx -o nginx.tar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 拷贝到不能联网到机器</span>
</span></span><span style=display:flex><span><span style=color:#75715e># scp / u盘 / ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 加载</span>
</span></span><span style=display:flex><span>docker load -i nginx.tar
</span></span></code></pre></div></li><li>总结<table><thead><tr><th>是否docker hub注册镜像</th><th>是否公开镜像</th><th>镜像仓库是否为https</th><th>是否有网</th><th>使用方法</th></tr></thead><tbody><tr><td>✔️</td><td>✔️</td><td>✔️</td><td>✔️</td><td>docker pull python:3.9.0</td></tr><tr><td>✖️</td><td>✔️</td><td>✔️</td><td>✔️</td><td>docker pull docker.elastic.co/logstash/logstash:7.6.0</td></tr><tr><td>✖️</td><td>✖️</td><td>✔️</td><td>✔️</td><td>docker login + docker pull</td></tr><tr><td>✖️</td><td>-</td><td>✖️</td><td>✔️</td><td>修改daemon后操作</td></tr><tr><td>-</td><td>-</td><td>-</td><td>✖️</td><td>docker save + docker load</td></tr></tbody></table></li></ul><h1 id=3-自己构建镜像>3. 自己构建镜像
<a class=anchor href=#3-%e8%87%aa%e5%b7%b1%e6%9e%84%e5%bb%ba%e9%95%9c%e5%83%8f>#</a></h1><h2 id=31-构建镜像流程>3.1 构建镜像流程
<a class=anchor href=#31-%e6%9e%84%e5%bb%ba%e9%95%9c%e5%83%8f%e6%b5%81%e7%a8%8b>#</a></h2><ol><li>写Dockerfile: 见下文</li><li><code>docker build</code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 用名为Dockerfile的dockerfile</span>
</span></span><span style=display:flex><span>docker build .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 指定dockerfile</span>
</span></span><span style=display:flex><span>docker build . -f Dockerfile_test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># build并打tag</span>
</span></span><span style=display:flex><span>docker build . -t test:0.1.0
</span></span></code></pre></div></li><li><code>docker tag</code></li><li><code>docker push</code></li></ol><h2 id=32-编写dockerfile>3.2 编写Dockerfile
<a class=anchor href=#32-%e7%bc%96%e5%86%99dockerfile>#</a></h2><ul><li>Dockerfile格式<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 基本格式：命令 参数</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>########################</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>###     拉基础镜像    ###</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>########################</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#FROM ubuntu</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>########################</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>###      一番操作     ###</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>###  （以下为常见命令） ###</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>########################</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置镜像根目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置镜像内的环境变量</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> COMPANY<span style=color:#f92672>=</span>wudun
</span></span><span style=display:flex><span><span style=color:#66d9ef>ENV</span> USER twomental<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置build阶段的参数</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> APP_NAME<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> APP_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.1.0<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 运行命令</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> /bin/sh -c <span style=color:#e6db74>&#34;echo </span>$COMPANY<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;echo </span>$USER<span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> echo $APP_NAME,$APP_VERSION<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 从目录里拷贝文件进镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> entrypoint.sh .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## .dockerignore</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>########################</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>###  指定容器启动命令  ###</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>########################</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## ENTRYPOINT（多个的话只运行最后一个）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> /app/entrypoint.sh hello<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/app/entrypoint.sh&#34;</span>, <span style=color:#e6db74>&#34;hello&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## CMD（多个的话只运行最后一个）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;echo&#34;</span>, <span style=color:#e6db74>&#34;$COMPANY&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> echo $USER<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## ENTRYPOINT + CMD</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;top&#34;</span>, <span style=color:#e6db74>&#34;-b&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;-c&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></li><li>例子<ul><li>解释型语言，以python项目为例<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.7.2-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LC_ALL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C.UTF-8&#34;</span> LANG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C.UTF-8&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex <span style=color:#f92672>&amp;&amp;</span> pip install --upgrade pip -i https://mirrors.aliyun.com/pypi/simple<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex <span style=color:#f92672>&amp;&amp;</span> pip3 install pipenv -i https://mirrors.aliyun.com/pypi/simple<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk update <span style=color:#f92672>&amp;&amp;</span> apk add py3-zmq <span style=color:#f92672>&amp;&amp;</span> apk add curl<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> Pipfile Pipfile.lock ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ONBUILD</span> <span style=color:#66d9ef>RUN</span> set -ex <span style=color:#f92672>&amp;&amp;</span> pipenv install --deploy --system<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install dependenciese, build and clean up. But keep c++ libs.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i <span style=color:#e6db74>&#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#39;</span> /etc/apk/repositories<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apk add --no-cache --virtual .build-deps <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ca-certificates <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    gcc <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    linux-headers <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    musl-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libffi-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    jpeg-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    zlib-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> pipenv install --system --deploy --ignore-pipfile <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> find /usr/local <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#ae81ff>\(</span> -type d -a -name test -o -name tests <span style=color:#ae81ff>\)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -o <span style=color:#ae81ff>\(</span> -type f -a -name <span style=color:#e6db74>&#39;*.pyc&#39;</span> -o -name <span style=color:#e6db74>&#39;*.pyo&#39;</span> <span style=color:#ae81ff>\)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -exec rm -rf <span style=color:#e6db74>&#39;{}&#39;</span> + <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> runDeps<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    scanelf --needed --nobanner --recursive /usr/local <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | awk <span style=color:#e6db74>&#39;{ gsub(/,/, &#34;\nso:&#34;, $2); print &#34;so:&#34; $2 }&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | sort -u <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | xargs -r apk info --installed <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | sort -u <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apk add --virtual .rundeps $runDeps <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apk del .build-deps<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/app/entrypoint.sh&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>STOPSIGNAL</span><span style=color:#e6db74> SIGTERM</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></li><li>编译型语言，以go项目为例<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># 阶段一：用于编译</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:alpine AS base</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build -o server .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 阶段二：用于运行</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>base /app/server ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> ./server<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></li></ul></li><li>善用多阶段构建<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker_test stage_1 5f953dcafb9c   About a minute ago   822MB
</span></span><span style=display:flex><span>docker_test stage_2 3c168da33a5a   About a minute ago   61.1MB
</span></span></code></pre></div></li></ul><h2 id=33-跨cpu架构build>3.3 跨CPU架构build
<a class=anchor href=#33-%e8%b7%a8cpu%e6%9e%b6%e6%9e%84build>#</a></h2><h3 id=331-buildx>3.3.1 buildx
<a class=anchor href=#331-buildx>#</a></h3><ul><li>适用场景：在x86的机器上build的镜像，希望能在arm的机器上跑起来</li><li>步骤<ol><li>qemu: 开启arm平台支持<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
</span></span></code></pre></div></li><li>安装buildx（以Ubuntu为例）<br>a. 下载机器对应的二进制安装包: <a href=https://github.com/docker/buildx/releases>buildx-release</a><br>b. 将其拷贝至$HOME/.docker/cli-plugins<br>c. 确认安装成功: <code>docker buildx version</code></li><li>初始化builder<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 新建一个builder instance, </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   名字叫arm(--name), </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   指定支持的平台(--platform), </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   指定driver(--driver), </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   使用(--use)</span>
</span></span><span style=display:flex><span>docker buildx create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --name arm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --platform linux/arm64,linux/arm,linux/amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --driver docker-container --use
</span></span><span style=display:flex><span><span style=color:#75715e># boot并查看</span>
</span></span><span style=display:flex><span>docker buildx inspect arm --bootstrap
</span></span></code></pre></div>其中:<ul><li>docker buildx create 用于新建builder<ul><li><code>--name</code>: 指定名称</li><li><code>--platform</code>: 支持架构, 包括arm64、arm、amd64等（详见<a href=https://github.com/containerd/containerd/blob/v1.7.13/platforms/platforms.go#L86>github</a>）</li><li><code>--use</code>: 使用这个builder</li></ul></li><li>docker buildx inspect 用于查看builder</li></ul></li><li>buildx<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker buildx build --platform linux/arm64 . -t <span style=color:#66d9ef>$(</span>IMG_NAME<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>TAG<span style=color:#66d9ef>)</span> -f Dockerfile --load
</span></span></code></pre></div>其中:<ul><li>docker buildx build用于build<ul><li><code>--platform</code>: 为哪些架构build</li><li><code>-t</code>: tag</li><li><code>-f</code>: dockerfile文件名</li><li><code>--load</code>: 将build完的镜像加载到docker（不然只在缓存里，docker images找不到这个镜像）</li></ul></li></ul></li></ol></li></ul><h3 id=332-manifest>3.3.2 manifest
<a class=anchor href=#332-manifest>#</a></h3><ul><li>适用场景：同一个tag的镜像，希望能在不同架构的设备上都能跑</li><li>步骤<ol><li>build image<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># build amd64</span>
</span></span><span style=display:flex><span>docker buildx build . --load <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -t <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f Dockerfile_amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --platform linux/amd64
</span></span><span style=display:flex><span><span style=color:#75715e># build arm64</span>
</span></span><span style=display:flex><span>docker buildx build . --load <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -t <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_arm64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f Dockerfile_arm64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --platform linux/arm64
</span></span></code></pre></div></li><li>push image<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># push amd64</span>
</span></span><span style=display:flex><span>docker push <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_amd64
</span></span><span style=display:flex><span><span style=color:#75715e># push arm64</span>
</span></span><span style=display:flex><span>docker push <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_arm64
</span></span></code></pre></div></li><li>create manifest<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker manifest create <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span> --amend <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_arm64
</span></span></code></pre></div></li><li>annotate manifest<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># anotate amd64</span>
</span></span><span style=display:flex><span>docker manifest annotate <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --os linux --arch amd64
</span></span><span style=display:flex><span><span style=color:#75715e># anotate arm64</span>
</span></span><span style=display:flex><span>docker manifest annotate <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>_arm64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --os linux --arch arm64 --variant v8
</span></span></code></pre></div></li><li>push manifest<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker manifest push <span style=color:#e6db74>${</span>IMG_NAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>IMG_VERSION<span style=color:#e6db74>}</span>
</span></span></code></pre></div></li></ol></li></ul><h1 id=4-运行容器>4. 运行容器
<a class=anchor href=#4-%e8%bf%90%e8%a1%8c%e5%ae%b9%e5%99%a8>#</a></h1><h2 id=41-容器启动停止>4.1 容器启动/停止
<a class=anchor href=#41-%e5%ae%b9%e5%99%a8%e5%90%af%e5%8a%a8%e5%81%9c%e6%ad%a2>#</a></h2><ul><li>启动容器：<code>docker run</code><ul><li>用法：<code>docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</code></li><li>常用options<ul><li><code>—name</code>：指定容器名称</li><li><code>—publish, -p</code>: 绑定容器端口到主机特定端口</li><li><code>—volume, -v</code>: 数据挂载</li><li><code>—env, -e</code>: 设置容器内环境变量</li><li><code>—env-file</code>: 用文件设置容器内环境变量</li><li><code>—restart</code>: 容器重启规则</li></ul></li></ul></li><li>同时启动多个容器：<code>docker-compose</code><ul><li>小工具：<a href=https://github.com/magicmark/composerize>composerize</a>，翻译docker命令行为docker-compose</li></ul></li><li>容器停止：<code>docker stop xxx</code></li><li>容器重启：<code>docker restart xxx</code> / <code>docker start xxx</code></li></ul><h2 id=42-容器查看>4.2 容器查看
<a class=anchor href=#42-%e5%ae%b9%e5%99%a8%e6%9f%a5%e7%9c%8b>#</a></h2><ul><li>查看运行中的容器：<code>docker ps</code></li><li>查看所有容器（包括运行的、停止的）：<code>docker ps -a</code></li><li>查看容器日志：<code>docker logs -f —tail 100 xxx</code></li><li>查看容器/镜像信息：<code>docker inspect xxx</code></li><li>在容器里执行命令：<code>docker exec</code><ul><li>用法：<code>docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</code></li><li>常用options<ul><li><code>—-interactive, -i</code>：进入交互</li><li>&mldr;</li></ul></li></ul></li></ul><h2 id=43-容器删除>4.3 容器删除
<a class=anchor href=#43-%e5%ae%b9%e5%99%a8%e5%88%a0%e9%99%a4>#</a></h2><ul><li>删除容器（容器已停止）：<code>docker rm xxx</code></li><li>删除容器（容器未停止）：<code>docker rm -f xxx</code></li><li>删除镜像（镜像未被使用）：<code>docker rmi xxx</code></li><li>删除镜像（镜像正在被使用）：<code>docker rmi -f xxx</code></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#11-docker原理>1.1 Docker原理</a></li><li><a href=#12-vs-虚拟机>1.2 VS 虚拟机</a></li></ul><ul><li><a href=#21-获取镜像>2.1 获取镜像</a></li></ul><ul><li><a href=#31-构建镜像流程>3.1 构建镜像流程</a></li><li><a href=#32-编写dockerfile>3.2 编写Dockerfile</a></li><li><a href=#33-跨cpu架构build>3.3 跨CPU架构build</a><ul><li><a href=#331-buildx>3.3.1 buildx</a></li><li><a href=#332-manifest>3.3.2 manifest</a></li></ul></li></ul><ul><li><a href=#41-容器启动停止>4.1 容器启动/停止</a></li><li><a href=#42-容器查看>4.2 容器查看</a></li><li><a href=#43-容器删除>4.3 容器删除</a></li></ul></nav></div></aside></main></body></html>